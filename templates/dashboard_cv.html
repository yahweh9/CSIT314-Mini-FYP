{% extends 'base.html' %}

{% block head %}
<title>CV Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css')}}">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block body %}
<div class="cv-dashboard">
    <h1>CV Dashboard</h1>
    <div class="header-options">
        <a href="{{ url_for('history_cv') }}">History</a>
        <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    </div>
</div>
<div class="welcome-message">
    <h2>Welcome, {{ user.fullname }}</h2>
</div>
<div>
    {% if requests %}
    <table class="my-table">
        <tr>
            <th>Request ID</th>
            <th>Title</th>
            <th>Name</th>
            <th>Location</th>
            <th>Status</th>
            
            <th>View Details</th>
        </tr>

        {% for req in requests %}
        <tr>
            <td>{{ req.request_id }}</td>
            <td>{{ req.title }}</td>
            <td>{{ req.pin_name }}</td>
            <td>{{ req.location }}</td>
            <td>
                <span class="status-badge {{ req.status|lower }}">
                    {{ req.status }}
                </span>
            </td>
            
            <td>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestModal{{ req.request_id }}">
                    Details
                </button>
            </td>
        </tr>
        {% endfor %}

        <!-- Modals -->
        {% for req in requests %}
        <div class="modal fade" id="requestModal{{ req.request_id }}" tabindex="-1" aria-labelledby="modalLabel{{ req.request_id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content p-3" style="border-radius: 15px;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel{{ req.request_id }}">{{ req.title }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>ID:</strong> {{ req.request_id }}</p>
                        <p><strong>Requested By:</strong> {{ req.pin_name }}</p>
                        <p><strong>Location:</strong> {{ req.location }}</p>
                        <p><strong>Status:</strong>
                        <span class="status-badge {{ req.status|lower }}">{{ req.status }}</span>
                        </p>
                        <p><strong>Description:</strong> {{ req.description }}</p>
                        <p><strong>Start Date:</strong> {{ req.start_date.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>End Date:</strong> {{ req.end_date.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Created On:</strong> {{ req.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                    <!-- Action buttons -->
                    <div class="modal-footer">
                        {% if req.status == 'pending' %}
                        <form action="{{ url_for('accept_request', request_id=req.request_id) }}" method="post">
                            <button type="submit" class="btn btn-success">Accept</button>
                        </form>
                        <form action="{{ url_for('reject_request', request_id=req.request_id) }}" method="post">
                            <button type="submit" class="btn btn-danger">Reject</button>
                        </form>
                        {% elif req.status == 'active' %}
                        <form action="{{ url_for('complete_request', request_id=req.request_id) }}" method="post">
                            <button type="submit" class="btn btn-primary">Mark as Completed</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}


    {% else %}
    <p class="no-requests-message">No active or pending requests assigned to you.</p>
    {% endif %}
</div>
{% endblock %}