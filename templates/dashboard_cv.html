{% extends 'base.html' %}

{% block head %}
<title>CV Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css')}}">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block body %}
<div class="cv-dashboard">
    <h1>CV Dashboard</h1>
    <div class="header-options">
        <a class=nav-bar-options href="{{ url_for('history_cv') }}">History</a>
        <a class=nav-bar-options href="{{ url_for('cv_account_info') }}">Account</a>
        <a class=nav-bar-options href="{{ url_for('logout') }}" class="logout">Logout</a>
    </div>
</div>
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} mt-3">
                <strong>{{ message }}</strong>
            </div>
        {% endfor %}
  {% endif %}
{% endwith %}
<div class="welcome-message">
    <h3>Welcome, {{ user.fullname }}. View your assigned request(s) below.</h3>
</div>
<div class="sort-options">
    <form method="get" class="row g-2 mb-3">
        <div class="col-sm-4">
            <label class="form-label">Sort by</label>
            <select name="sort" class="form-select">
            <option value="">Default</option>
            <option value="end_date_asc"  {{ 'selected' if request.args.get('sort')=='end_date_asc' }}>Deadline (Earliest First)</option>
            <option value="end_date_desc" {{ 'selected' if request.args.get('sort')=='end_date_desc' }}>Deadline (Latest First)</option>
            </select>
        </div>
        <div class="col-sm-4">
            <label class="form-label">Filter Status</label>
            <select name="status" class="form-select">
                <option value="">All</option>
                <option value="pending"  {{ 'selected' if request.args.get('status')=='pending' }}>Pending</option>
                <option value="active"   {{ 'selected' if request.args.get('status')=='active' }}>Active</option>
                <option value="late"     {{ 'selected' if request.args.get('status')=='late' }}>Late</option>
            </select>
        </div>
        <div class="col-sm-4">
            <label class="form-label">Filter Urgency</label>
            <select name="urgency" class="form-select">
            <option value="">All</option>
            <option value="high"   {{ 'selected' if request.args.get('urgency')=='high' }}>High</option>
            <option value="medium" {{ 'selected' if request.args.get('urgency')=='medium' }}>Medium</option>
            <option value="low"    {{ 'selected' if request.args.get('urgency')=='low' }}>Low</option>
            </select>
        </div>
        <div class="col-sm-4"></div>
        <div class="col-sm-4 align-self-end">
            <button class="btn btn-secondary w-100" type="submit">Apply Sort/Filter Options</button>
        </div>
    </form>
    {% if requests %}
    <table class="my-table">
        <tr>
            <th>Request ID</th>
            <th>Title</th>
            <th>Service Category</th>
            <th>PIN Name</th>
            <th>Status</th>
            <th>Urgency</th>
            <th>Deadline</th>
            <th>View Details</th>
        </tr>

        {% for req in requests %}
        <tr>
            <td>{{ req.request_id }}</td>
            <td>{{ req.title }}</td>
            <td class="cv-service-type">{{ req.service_type }}</td>
            <td>{{ req.pin_name }}</td>
            <td>
                <span class="status-badge {{ req.status|lower }}">
                    {{ req.status }}
                </span>
            </td>
            <td>
                <span class="urgency-badge {{ req.urgency|lower }}">
                    {{ req.urgency }}
                </span>
            </td>
            <td>{{ req.end_date.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestModal{{ req.request_id }}">
                    Details
                </button>
            </td>
        </tr>
        {% endfor %}

        <!-- Modals -->
        {% for req in requests %}
        <div class="modal fade" id="requestModal{{ req.request_id }}" tabindex="-1" aria-labelledby="modalLabel{{ req.request_id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content p-3" style="border-radius: 15px;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel{{ req.request_id }}">{{ req.title }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>ID:</strong> {{ req.request_id }}</p>
                        <p><strong>Requested By:</strong> {{ req.pin_name }}</p>
                        <p><strong>Location:</strong> {{ req.location }}</p>
                        <p><strong>Status:</strong>
                        <span class="status-badge {{ req.status|lower }}">{{ req.status }}</span>
                        </p>
                        <p><strong>Description:</strong> {{ req.description }}</p>
                        <p><strong>Start Date:</strong> {{ req.start_date.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>End Date:</strong> {{ req.end_date.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Created On:</strong> {{ req.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                    <!-- Action buttons -->
                    <div class="modal-footer">
                        {% if req.status == 'pending' %}
                        <form action="{{ url_for('accept_request', request_id=req.request_id) }}" method="post">
                            <button type="submit" class="btn btn-success">Accept</button>
                        </form>
                        <form action="{{ url_for('reject_request', request_id=req.request_id) }}" method="post">
                            <button type="submit" class="btn btn-danger">Reject</button>
                        </form>
                        {% elif req.status == 'active' or req.status == 'late' %}
                        <form action="{{ url_for('complete_request', request_id=req.request_id) }}" method="post">
                            <button type="submit" class="btn btn-primary">Mark as Completed</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% else %}
        <p class="no-requests-message">No requests found. If you have filters applied, try resetting them or applying a different one.</p>
        {% endif %}
    </table>

    <h2>Unassigned Requests</h2>

    {% if unassigned_req %}
    <table class="my-table">
        <tr>
            <th>Request ID</th>
            <th>Title</th>
            <th>Service Category</th>
            <th>PIN Name</th>
            <th>Status</th>
            <th>Urgency</th>
            <th>Deadline</th>
            <th>View Details</th>
        </tr>
        
        {% for u_req in unassigned_req %}
        <tr>
            <td>{{ u_req.request_id }}</td>
            <td>{{ u_req.title }}</td>
            <td class="cv-service-type">{{ u_req.service_type }}</td>
            <td>{{ u_req.pin_name }}</td>
            <td>
                <span class="status-badge {{ u_req.status|lower }}">
                    {{ u_req.status }}
                </span>
            </td>
            <td>
                <span class="urgency-badge {{ u_req.urgency|lower }}">
                    {{ u_req.urgency }}
                </span>
            </td>
            <td>{{ u_req.end_date.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>
                <a class="btn btn-primary"
                href="{{ url_for('view_request', request_id=u_req.request_id) }}">
                    Details
                </a>

            </td>
        </tr>
        {% endfor %}

        <!-- Modals -->
        {% for u_req in unassigned_req %}
        
        <div class="modal fade" id="requestModal{{ u_req.request_id }}" tabindex="-1" aria-labelledby="modalLabel{{ u_req.request_id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content p-3" style="border-radius: 15px;">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel{{ u_req.request_id }}">{{ u_req.title }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>ID:</strong> {{ u_req.request_id }}</p>
                        <p><strong>Requested By:</strong> {{ u_req.pin_name }}</p>
                        <p><strong>Location:</strong> {{ u_req.location }}</p>
                        <p><strong>Status:</strong>
                        <span class="status-badge {{ u_req.status|lower }}">{{ u_req.status }}</span>
                        </p>
                        <p><strong>Description:</strong> {{ u_req.description }}</p>
                        <p><strong>Start Date:</strong> {{ u_req.start_date.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>End Date:</strong> {{ u_req.end_date.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Created On:</strong> {{ u_req.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                    <!-- Action buttons -->
                    <div class="modal-footer">
                        
                        <form action="{{ url_for('express_interest', request_id=u_req.request_id) }}" method="post">
                            <button type="submit" class="btn btn-success">Express Interest</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <p class="no-requests-message">No unassigned requests found.</p>
    {% endif %}
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const reqId = "{{ request.args.get('open') }}";
    if (reqId) {
        const modalElement = document.getElementById("requestModal" + reqId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    }
});
</script>

{% endblock %}