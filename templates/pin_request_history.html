{% extends 'base.html' %}

{% block head %}
<title>Request History</title>
<style>
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .history-card { 
        background: white; 
        border: 1px solid #e0e0e0; 
        border-radius: 8px; 
        padding: 20px; 
        margin-bottom: 15px;
    }
    .history-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
    .history-title { font-size: 1.2em; font-weight: bold; color: #333; margin: 0; }
    .status-badge { 
        padding: 4px 12px; 
        border-radius: 20px; 
        font-size: 0.85em; 
        font-weight: bold; 
    }
    .status-completed { background: #d1ecf1; color: #0c5460; }
    .status-late { background: #f8d7da; color: #721c24; }
    .status-cancelled { background: #e2e3e5; color: #383d41; }
    .history-meta { color: #666; margin-bottom: 10px; }
    .outcome { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    .filter-form { margin-bottom: 25px; }
    .filter-form label { font-weight: bold; margin-right: 8px; }
</style>
{% endblock %}

{% block body %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>Request History</h1>
        <div>
            <a href="{{ url_for('pin_my_requests') }}" class="btn btn-secondary">Active Requests</a>
            <a href="{{ url_for('pin_create_request') }}" class="btn btn-primary">+ New Request</a>
        </div>
    </div>

    <!-- üîé Filter form -->
    <form method="get" action="{{ url_for('pin_request_history') }}" class="filter-form">
        <label for="service_type">Service Type:</label>
        <select id="service_type" name="service_type">
            <option value="">All</option>
            {% for cat in categories %}
                <option value="{{ cat.name }}" {% if service_type == cat.name %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
        </select>

        <label for="status">Status:</label>
        <select id="status" name="status">
            <option value="">All</option>
            <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
            <option value="late" {% if status == 'late' %}selected{% endif %}>Late</option>
            <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
        </select>

        <label for="date">Date:</label>
        <input type="date" id="date" name="date" value="{{ date or '' }}">

        <button type="submit" class="btn btn-primary">Apply Filters</button>
    </form>

    <!-- Flash messages for errors -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if requests %}
        {% for request in requests %}
        <div class="history-card">
            <div class="history-header">
                <h3 class="history-title">{{ request.title }}</h3>
                <span class="status-badge status-{{ request.status }}">
                    {{ request.status|title }}
                </span>
            </div>
            
            <div class="history-meta">
                <strong>Type:</strong> {{ request.service_type|title if request.service_type else 'Not specified' }} | 
                <strong>Location:</strong> {{ request.location if request.location else 'Not specified' }} |
                <strong>Date:</strong>
                {% if request.completed_date %}
                    {{ request.completed_date.strftime('%Y-%m-%d') }}
                {% elif request.cancelled_at %}
                    {{ request.cancelled_at.strftime('%Y-%m-%d') }}
                {% else %}
                    {{ request.created_at.strftime('%Y-%m-%d') }}
                 {% endif %}
            </div>
            
            <p>{{ request.description }}</p>
            
            <div class="outcome">
                <strong>Final Outcome:</strong> 
                <span style="color: #666;">
                    {% if request.status == 'completed' %}
                        ‚úÖ Successfully completed with volunteer assistance
                    {% elif request.status == 'late' %}
                        ‚è∞ Request expired without completion
                    {% elif request.status == 'cancelled' %}
                        ‚ùå Request was cancelled by the PIN
                    {% else %}
                        ‚ÑπÔ∏è {{ request.status|title }}
                    {% endif %}
                </span>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <p>Your completed, late or cancelled requests will appear here.</p>
            <a href="{{ url_for('pin_create_request') }}" class="btn btn-primary" style="margin-top: 15px;">
                Create Your First Request
            </a>
        </div>
    {% endif %}

    <div>
        <a href="{{ url_for('dashboard_pin') }}" class="btn btn-primary">
                   ‚Üê Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}